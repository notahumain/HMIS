const API=location.origin+'/api'
function setToken(t){localStorage.setItem('t',t)}
function getToken(){return localStorage.getItem('t')}
function authHeader(){return {Authorization:'Bearer '+getToken()}}
function requireAuth(){if(!getToken())location.href='/'}
function logout(){localStorage.removeItem('t');location.href='/'}
document.addEventListener('click',e=>{if(e.target.id==='logout')logout()})
async function req(u,o){const r=await fetch(u,Object.assign({headers:Object.assign({'Content-Type':'application/json'},authHeader())},o));if(r.status===401){logout();return}return r.json()}
function initLogin(){const f=document.getElementById('loginForm');f.addEventListener('submit',async e=>{e.preventDefault();const email=document.getElementById('email').value.trim();const password=document.getElementById('password').value.trim();const r=await fetch(API+'/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})});if(r.ok){const x=await r.json();setToken(x.token);localStorage.setItem('role',x.role);localStorage.setItem('name',x.name);location.href='/dashboard.html'}else alert('Invalid')})}
function loadDashboard(){document.getElementById('who').textContent=localStorage.getItem('name')+' ('+localStorage.getItem('role')+')';stats()}
async function stats(){const ps=await req(API+'/patients');const as=await req(API+'/appointments');const bs=await req(API+'/billing');document.getElementById('stats').innerHTML='<div>Patients: '+ps.length+'</div><div>Appointments: '+as.length+'</div><div>Bills: '+bs.length+'</div>'}
async function listPatients(){const q=document.getElementById('q');q.addEventListener('input',()=>listPatients());const data=await req(API+'/patients?q='+(q.value||''));const tb=document.querySelector('#ptab tbody');tb.innerHTML='';data.forEach(r=>{const tr=document.createElement('tr');tr.innerHTML='<td>'+r.patient_uid+'</td><td>'+r.name+'</td><td>'+(r.dob||'')+'</td><td>'+r.gender+'</td><td>'+(r.phone||'')+'</td><td>'+(r.address||'')+'</td><td><button data-id="'+r.id+'" class="delp">Delete</button></td>';tb.appendChild(tr)});tb.querySelectorAll('.delp').forEach(b=>b.onclick=async()=>{if(confirm('Delete?')){await req(API+'/patients/'+b.dataset.id,{method:'DELETE'});listPatients()}})}
function bindPatientForm(){const f=document.getElementById('addPatient');f.addEventListener('submit',async e=>{e.preventDefault();const fd=new FormData(f);const x=Object.fromEntries(fd.entries());const r=await req(API+'/patients',{method:'POST',body:JSON.stringify(x)});if(r&&r.id){f.reset();listPatients()}else alert('Failed')})}
async function listAppointments(){const data=await req(API+'/appointments');const tb=document.querySelector('#atab tbody');tb.innerHTML='';data.forEach(r=>{const tr=document.createElement('tr');tr.innerHTML='<td>'+r.id+'</td><td>'+r.patient+'</td><td>'+r.doctor+'</td><td>'+new Date(r.scheduled_at).toLocaleString()+'</td><td><span class="pill">'+r.status+'</span></td><td><button data-id="'+r.id+'" data-s="completed" class="st">Done</button> <button data-id="'+r.id+'" data-s="cancelled" class="st">Cancel</button></td>';tb.appendChild(tr)});tb.querySelectorAll('.st').forEach(b=>b.onclick=async()=>{await req(API+'/appointments/'+b.dataset.id+'/status',{method:'PUT',body:JSON.stringify({status:b.dataset.s})});listAppointments()})}
function bindApptForm(){const f=document.getElementById('addAppt');f.addEventListener('submit',async e=>{e.preventDefault();const fd=new FormData(f);const x=Object.fromEntries(fd.entries());x.patient_id=Number(x.patient_id);x.doctor_id=Number(x.doctor_id);const r=await req(API+'/appointments',{method:'POST',body:JSON.stringify(x)});if(r&&r.id){f.reset();listAppointments()}else alert('Failed')})}
async function listBills(){const data=await req(API+'/billing');const tb=document.querySelector('#btab tbody');tb.innerHTML='';data.forEach(r=>{const tr=document.createElement('tr');tr.innerHTML='<td>'+r.id+'</td><td>'+r.patient+'</td><td class="num">₹'+Number(r.amount).toFixed(2)+'</td><td><span class="pill">'+r.status+'</span></td><td>'+(r.status==='unpaid'?'<button class="pay" data-id="'+r.id+'">Mark Paid</button>':'')+' <button class="view" data-id="'+r.id+'">Items</button></td>';tb.appendChild(tr)});tb.querySelectorAll('.pay').forEach(b=>b.onclick=async()=>{await req(API+'/billing/'+b.dataset.id+'/pay',{method:'PUT'});listBills()});tb.querySelectorAll('.view').forEach(b=>b.onclick=async()=>{const items=await req(API+'/billing/'+b.dataset.id+'/items');alert(items.map(i=>i.item+' x'+i.qty+' = ₹'+Number(i.price*i.qty).toFixed(2)).join('\n'))})}
function bindBillForm(){const f=document.getElementById('makeBill');f.addEventListener('submit',async e=>{e.preventDefault();const fd=new FormData(f);const patient_id=Number(fd.get('patient_id'));let items=[];try{items=JSON.parse(fd.get('items'))}catch(e){}const r=await req(API+'/billing',{method:'POST',body:JSON.stringify({patient_id,items})});if(r&&r.id){f.reset();listBills()}else alert('Failed')})}